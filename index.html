<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen fisiopatolog칤a - Nuevo</title>
    <style>
        /* Estilos CSS existentes de tu archivo */
        .moon-creaciones {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 16px;
            font-weight: bold;
             /* A침adimos flexbox para alinear el texto y la imagen */
            display: flex;
            align-items: center; /* Centra verticalmente el texto y la imagen */
            gap: 5px; /* Espacio entre el texto y la imagen */
        }
         .moon-creaciones img {
            height: 30px; /* Ajusta el tama침o del gato banana */
            width: auto; /* Mantiene la proporci칩n */
        }
        .correcta {
            color: green;
        }
        .incorrecta {
            color: red;
        }
        /* Estilo para el GIF al finalizar el examen */
        .finished-exam-gif {
            display: block;
            margin: 20px auto; /* Centra la imagen y a침ade espacio arriba y abajo */
            max-width: 250px; /* Limita el ancho m치ximo del GIF */
            height: auto; /* Mantiene la proporci칩n */
        }
    </style>
</head>
<body>
    <div class="moon-creaciones">
        moon creaciones游깿
        <img src="assets/banana-cat-heart.gif" alt="Banana Cat Coraz칩n">
    </div>
    <h1>Nuevo Examen de Fisiopatolog칤a</h1>
    <div id="preguntas"></div>
    <button id="enviarRespuestas" style="display:none;">Enviar Respuestas</button>
    <div id="resultados"></div>
    <button id="nuevoExamen" style="display:block;" onclick="generarNuevoExamen()">Generar Nuevo Examen</button>

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            let preguntasRespondidas = new Set();
            let preguntasSeleccionadas = [];
             // Inicializa totalPreguntas a 0, se actualizar치 al cargar Hoja 1.html
            let totalPreguntas = 0;
            let preguntasPorExamen = 42;
            // Aseg칰rate que estos cap칤tulos sean los correctos seg칰n tu Hoja 1.html
            let capitulos = ["1", "2", "3", "4", "5", "6", "9", "10", "11", "12", "21", "22", "23", "24", "36", "37", "39", "41"];
            let preguntasPorCapitulo = {};

            // Funci칩n para cargar las preguntas desde el archivo HTML
            async function cargarPreguntas() {
                try {
                    let response = await fetch('Hoja 1.html');
                    if (!response.ok) {
                        throw new Error(`Error al cargar Hoja 1.html: ${response.statusText}`);
                    }
                    let text = await response.text();
                    let parser = new DOMParser();
                    let doc = parser.parseFromString(text, 'text/html');
                    let filas = doc.querySelectorAll("table.waffle tbody tr");

                    if (filas.length <= 1) {
                        throw new Error("No se encontraron filas de preguntas v치lidas en Hoja 1.html.");
                    }

                    filas.forEach((fila, index) => {
                        if (index === 0) return; // Saltar encabezado
                        let celdas = fila.querySelectorAll("td");
                         // Asegurarse de que hay suficientes celdas
                        if (celdas.length > 6) {
                            let capitulo = celdas[0].innerText.trim();
                            let pregunta = celdas[1].innerText.trim();
                            let opciones = [
                                celdas[2].innerText.trim(),
                                celdas[3].innerText.trim(),
                                celdas[4].innerText.trim(),
                                celdas[5].innerText.trim()
                            ];
                            let respuestaCorrecta = celdas[6].innerText.trim();

                            // Limpieza b치sica de las opciones y respuesta correcta
                            opciones = opciones.map(opcion => opcion.replace(/[\r\n]+/g, '').trim());
                            respuestaCorrecta = respuestaCorrecta.replace(/[\r\n]+/g, '').trim();


                            if (capitulos.includes(capitulo)) {
                                if (!preguntasPorCapitulo[capitulo]) {
                                    preguntasPorCapitulo[capitulo] = [];
                                }
                                preguntasPorCapitulo[capitulo].push({
                                    capitulo,
                                    pregunta,
                                    opciones,
                                    respuestaCorrecta
                                });
                            }
                        } else {
                            console.warn(`Fila ${index + 1} ignorada: n칰mero insuficiente de celdas.`);
                        }
                    });

                    let totalPreguntasCargadas = Object.values(preguntasPorCapitulo).flat().length;
                    if (totalPreguntasCargadas === 0) {
                       document.getElementById("preguntas").innerHTML = `<h2>No se cargaron preguntas con los cap칤tulos especificados. Revisa Hoja 1.html y la lista de cap칤tulos.</h2>`;
                       document.getElementById("enviarRespuestas").style.display = "none";
                       document.getElementById("nuevoExamen").style.display = "none";
                       console.warn('No se cargaron preguntas despu칠s de filtrar por cap칤tulo.');
                    } else {
                        totalPreguntas = totalPreguntasCargadas; // Ajusta el total al n칰mero real cargado
                        console.log(`Total de preguntas cargadas y filtradas: ${totalPreguntas}`);
                        generarNuevoExamen(); // Genera el primer examen
                    }

                } catch (error) {
                    console.error("Error al cargar las preguntas:", error);
                    document.getElementById("preguntas").innerHTML = `<h2>Error al cargar las preguntas: ${error.message}</h2>`;
                    document.getElementById("enviarRespuestas").style.display = "none";
                    document.getElementById("nuevoExamen").style.display = "none";
                }
            }

            function seleccionarPreguntas() {
                preguntasSeleccionadas = [];
                let disponibles = Object.values(preguntasPorCapitulo).flat().filter(p => !preguntasRespondidas.has(p.pregunta));

                if (disponibles.length === 0) {
                    // Si no hay preguntas disponibles, muestra el mensaje final con el GIF
                    mostrarMensajeFinal();
                    return;
                }

                let seleccionadas = disponibles.sort(() => 0.5 - Math.random()).slice(0, preguntasPorExamen);
                preguntasSeleccionadas.push(...seleccionadas);
                seleccionadas.forEach(p => preguntasRespondidas.add(p.pregunta));

                document.getElementById("enviarRespuestas").style.display = "block";
                document.getElementById("nuevoExamen").style.display = "none";
            }

            function mostrarPreguntas() {
                let contenedor = document.getElementById("preguntas");
                contenedor.innerHTML = "";
                preguntasSeleccionadas.forEach((pregunta, index) => {
                    let div = document.createElement("div");
                    let opcionesHTML = pregunta.opciones.map((opcion, i) => {
                         // Limpiar opci칩n antes de usar en el value y en el texto mostrado
                        let opcionValue = opcion.replace(/'/g, "&#039;").replace(/"/g, "&quot;").replace(/[\r\n]+/g, '').trim();
                        let opcionTexto = opcion.replace(/[\r\n]+/g, '').trim(); // Limpia solo el texto mostrado
                         return `<label><input type='radio' name='pregunta${index}' value='${opcionValue}'> ${opcionTexto}</label><br>`;
                    }).join('');

                    div.innerHTML = `
                        <p><strong>${index + 1}. ${pregunta.pregunta} (Cap칤tulo ${pregunta.capitulo})</strong></p>
                        ${opcionesHTML}
                    `;
                    contenedor.appendChild(div);
                });
                document.getElementById("enviarRespuestas").style.display = "block";
                 // Oculta el bot칩n de "Generar Nuevo Examen" mientras se responde
                document.getElementById("nuevoExamen").style.display = "none";
            }

            function evaluarRespuestas() {
                let correctas = 0;
                preguntasSeleccionadas.forEach((pregunta, index) => {
                    // Limpia la respuesta correcta antes de comparar
                    let respuestaCorrectaLimpia = pregunta.respuestaCorrecta.replace(/[\r\n]+/g, '').trim();

                    let respuestaUsuarioInput = document.querySelector(`input[name='pregunta${index}']:checked`);
                    // Limpia el valor de la respuesta del usuario antes de comparar
                    let respuestaUsuarioLimpia = respuestaUsuarioInput ? respuestaUsuarioInput.value.replace(/[\r\n]+/g, '').trim() : null;


                    let opcionesLabel = document.querySelectorAll(`input[name='pregunta${index}']`);
                    opcionesLabel.forEach(input => {
                        let label = input.parentElement;
                        // Limpia el valor de la opci칩n antes de comparar
                        let opcionValueLimpia = input.value.replace(/[\r\n]+/g, '').trim();

                        if (opcionValueLimpia === respuestaCorrectaLimpia) {
                            label.classList.add('correcta');
                        }
                         // Verifica que el usuario haya respondido antes de marcar incorrecta
                        if (respuestaUsuarioLimpia !== null && opcionValueLimpia === respuestaUsuarioLimpia && opcionValueLimpia !== respuestaCorrectaLimpia) {
                            label.classList.add('incorrecta');
                        }
                        input.disabled = true; // Deshabilita los botones despu칠s de evaluar
                    });

                    if (respuestaUsuarioLimpia !== null && respuestaUsuarioLimpia === respuestaCorrectaLimpia) {
                        correctas++;
                    }
                });

                mostrarResultados(correctas);
                document.getElementById("enviarRespuestas").style.display = "none"; // Oculta el bot칩n despu칠s de evaluar

                let preguntasDisponiblesRestantes = Object.values(preguntasPorCapitulo).flat().filter(p => !preguntasRespondidas.has(p.pregunta)).length;
                if (preguntasDisponiblesRestantes > 0) {
                    document.getElementById("nuevoExamen").innerText = "Siguiente Ronda";
                    document.getElementById("nuevoExamen").style.display = "block";
                } else {
                    // Muestra el mensaje final con el GIF cuando se agotan las preguntas
                    mostrarMensajeFinal();
                }
            }

            function mostrarResultados(correctas) {
                let resultadoDiv = document.getElementById("resultados");
                resultadoDiv.innerHTML = `<p>Respuestas correctas en esta ronda: ${correctas}/${preguntasSeleccionadas.length}</p>`;
            }

             // Funci칩n para mostrar el mensaje final con el GIF del gato bailando
            function mostrarMensajeFinal() {
                document.getElementById("preguntas").innerHTML = `
                     <h2>춰Enhorabuena! Respondiste todas las preguntas disponibles. 쯈uieres empezar de nuevo?</h2>
                     <img src="assets/catdancing.gif" alt="GIF de felicitaci칩n" class="finished-exam-gif">
                 `; // Usa la ruta y nombre de tu GIF de gato bailando
                 document.getElementById("resultados").innerHTML = ""; // Limpia los resultados de la 칰ltima ronda
                 document.getElementById("enviarRespuestas").style.display = "none";
                 document.getElementById("nuevoExamen").innerText = "Reiniciar Examen";
                 document.getElementById("nuevoExamen").style.display = "block";
            }


            window.generarNuevoExamen = function () {
                let preguntasDisponiblesRestantes = Object.values(preguntasPorCapitulo).flat().filter(p => !preguntasRespondidas.has(p.pregunta)).length;

                if (preguntasDisponiblesRestantes === 0 && Object.values(preguntasPorCapitulo).flat().length > 0) {
                     // Si ya no hay preguntas disponibles pero s칤 se cargaron preguntas inicialmente
                     mostrarMensajeFinal();
                } else if (Object.values(preguntasPorCapitulo).flat().length === 0){
                    // Esto ocurre si no se carg칩 ninguna pregunta inicialmente
                    document.getElementById("preguntas").innerHTML = `<h2>No se pudieron cargar las preguntas. Por favor, revisa el archivo Hoja 1.html.</h2>`;
                    document.getElementById("enviarRespuestas").style.display = "none";
                    document.getElementById("nuevoExamen").style.display = "none";
                }
                 else {
                    console.log("Generando nuevo set de preguntas...");
                    seleccionarPreguntas();
                    // Verifica si se seleccionaron preguntas antes de mostrarlas
                    if (preguntasSeleccionadas.length > 0) {
                        mostrarPreguntas();
                        document.getElementById("resultados").innerHTML = ""; // Limpia los resultados anteriores
                         // Asegura que el bot칩n de "Enviar Respuestas" est칠 visible para la nueva ronda
                        document.getElementById("enviarRespuestas").style.display = "block";
                        document.getElementById("nuevoExamen").style.display = "none"; // Oculta el bot칩n de "Generar Nuevo Examen"
                    } else {
                         // Esto solo pasar칤a si no hay suficientes preguntas no respondidas para una ronda completa
                         // O si hay alg칰n problema l칩gico. Aqu칤 mostramos el mensaje final.
                         mostrarMensajeFinal();
                    }
                }
            };

            document.getElementById("enviarRespuestas").addEventListener("click", evaluarRespuestas);

            window.reiniciarExamen = function () {
                preguntasRespondidas.clear(); // Limpia el set de preguntas respondidas
                document.getElementById("resultados").innerHTML = ""; // Limpia los resultados
                // Limpia el contenido actual de las preguntas
                document.getElementById("preguntas").innerHTML = "";
                console.log("Reiniciando examen...");

                // Vuelve a cargar las preguntas y genera el primer set
                 if (Object.values(preguntasPorCapitulo).flat().length > 0) {
                     generarNuevoExamen(); // Genera el primer set del examen reiniciado
                     document.getElementById("nuevoExamen").innerText = "Generar Nuevo Examen"; // Restaura el texto del bot칩n
                 } else {
                     // Si no se cargaron preguntas al inicio, muestra el mensaje de error
                     document.getElementById("preguntas").innerHTML = `<h2>No se pudieron cargar las preguntas para reiniciar. Por favor, revisa el archivo Hoja 1.html.</h2>`;
                     document.getElementById("enviarRespuestas").style.display = "none";
                     document.getElementById("nuevoExamen").style.display = "none";
                 }
            };


            // Carga las preguntas al iniciar la p치gina
            cargarPreguntas();
        });
    </script>
</body>
</html>
