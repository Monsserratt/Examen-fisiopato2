<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen fisiopatologÃ­a - Nuevo</title> <style>
        /* Estilos CSS existentes de tu archivo */
        .moon-creaciones {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        .correcta {
            color: green;
        }
        .incorrecta {
            color: red;
        }
    </style>
</head>
<body>
    <div class="moon-creaciones">
        moon creacionesðŸŒ™
    </div>
    <h1>Nuevo Examen de FisiopatologÃ­a</h1> <div id="preguntas"></div>
    <button id="enviarRespuestas">Enviar Respuestas</button> <div id="resultados"></div>
    <button id="nuevoExamen" style="display:none;" onclick="generarNuevoExamen()">Generar Nuevo Examen</button> <script>
        document.addEventListener("DOMContentLoaded", async function () {
            let preguntas = [];
            let preguntasRespondidas = new Set();
            let preguntasSeleccionadas = [];
            // AsegÃºrate que este nÃºmero coincida con el total de preguntas en tu nueva Hoja 1.html
            let totalPreguntas = 155; // Actualizado segÃºn el conteo de filas en tu nueva Hoja 1.html, ajusta si no es exacto
            let preguntasPorExamen = 42; // Puedes ajustar este nÃºmero si quieres exÃ¡menes mÃ¡s largos o cortos
            // Actualiza los capÃ­tulos si son diferentes en tu nueva Hoja 1.html
            let capitulos = ["1", "2", "3", "4", "5", "6", "9", "10", "11", "12", "21", "22", "23", "24", "36", "37", "39", "41"]; // Actualizado segÃºn los capÃ­tulos en tu nueva Hoja 1.html

            // FunciÃ³n para cargar las preguntas desde el archivo HTML
            async function cargarPreguntas() {
                // AquÃ­ se carga el archivo Hoja 1.html. AsegÃºrate que este archivo estÃ© en el mismo directorio que index.html en tu repositorio de GitHub.
                let response = await fetch('Hoja 1.html');
                let text = await response.text();
                let parser = new DOMParser();
                let doc = parser.parseFromString(text, 'text/html');
                let filas = doc.querySelectorAll("table.waffle tbody tr");

                filas.forEach((fila, index) => {
                    // Se salta la primera fila que usualmente son los encabezados de la tabla
                    if (index === 0) return;
                    let celdas = fila.querySelectorAll("td");
                    // Verifica que haya suficientes celdas antes de intentar acceder a ellas
                    if (celdas.length > 6) {
                        let capitulo = celdas[0].innerText.trim();
                        let pregunta = celdas[1].innerText.trim();
                        // Extrae las 4 opciones. AsegÃºrate de que las columnas coincidan con tu Hoja 1.html
                        let opciones = [celdas[2].innerText.trim(), celdas[3].innerText.trim(), celdas[4].innerText.trim(), celdas[5].innerText.trim()];
                        let respuestaCorrecta = celdas[6].innerText.trim();

                        // Filtra por los capÃ­tulos que te interesan
                        if (capitulos.includes(capitulo)) {
                            if (!preguntasPorCapitulo[capitulo]) {
                                preguntasPorCapitulo[capitulo] = [];
                            }
                            preguntasPorCapitulo[capitulo].push({
                                capitulo,
                                pregunta,
                                opciones,
                                respuestaCorrecta
                            });
                        }
                    } else {
                        console.warn(`Fila ${index + 1} ignorada debido a un nÃºmero insuficiente de celdas.`);
                    }
                });
                 // Verificar que se hayan cargado preguntas antes de generar el examen
                let totalPreguntasCargadas = Object.values(preguntasPorCapitulo).flat().length;
                if (totalPreguntasCargadas === 0) {
                     document.getElementById("preguntas").innerHTML = `<h2>No se pudieron cargar las preguntas. Por favor, revisa el archivo Hoja 1.html.</h2>`;
                     document.getElementById("enviarRespuestas").style.display = "none";
                     document.getElementById("nuevoExamen").style.display = "none";
                } else {
                    totalPreguntas = totalPreguntasCargadas; // Ajusta el total de preguntas al nÃºmero real cargado
                    generarNuevoExamen(); // Genera el primer examen una vez cargadas las preguntas
                }
            }

            // AsegÃºrate de definir preguntasPorCapitulo antes de usarlo
            let preguntasPorCapitulo = {};


            function seleccionarPreguntas() {
                // Esta funciÃ³n selecciona preguntas aleatorias que no se han respondido aÃºn
                preguntasSeleccionadas = [];
                let disponibles = Object.values(preguntasPorCapitulo).flat().filter(p => !preguntasRespondidas.has(p.pregunta));

                if (disponibles.length === 0) {
                    // Si no hay preguntas disponibles, reinicia el examen
                    document.getElementById("preguntas").innerHTML = `<h2>Â¡Enhorabuena! Respondiste todas las preguntas disponibles. Â¿Quieres empezar de nuevo?</h2>`;
                    document.getElementById("enviarRespuestas").style.display = "none";
                    document.getElementById("nuevoExamen").style.display = "block";
                    return; // Sale de la funciÃ³n
                }

                let seleccionadas = disponibles.sort(() => 0.5 - Math.random()).slice(0, preguntasPorExamen);
                preguntasSeleccionadas.push(...seleccionadas);
                seleccionadas.forEach(p => preguntasRespondidas.add(p.pregunta));
                 // Asegura que el botÃ³n de enviar respuestas estÃ© visible cuando hay preguntas seleccionadas
                document.getElementById("enviarRespuestas").style.display = "block";
                document.getElementById("nuevoExamen").style.display = "none"; // Oculta el botÃ³n de nuevo examen
            }

            function mostrarPreguntas() {
                // Esta funciÃ³n muestra las preguntas seleccionadas en el HTML
                let contenedor = document.getElementById("preguntas");
                contenedor.innerHTML = "";
                preguntasSeleccionadas.forEach((pregunta, index) => {
                    let div = document.createElement("div");
                    let opcionesHTML = pregunta.opciones.map((opcion, i) => {
                        // Se asigna un name Ãºnico por pregunta para que solo se pueda seleccionar una opciÃ³n
                        return `<label><input type='radio' name='pregunta${index}' value='${opcion.replace(/'/g, "&#039;")}'> ${opcion}</label><br>`; // Reemplaza comillas simples para evitar problemas en el valor
                    }).join('');

                    div.innerHTML = `
                        <p><strong>${index + 1}. ${pregunta.pregunta} (CapÃ­tulo ${pregunta.capitulo})</strong></p>
                        ${opcionesHTML}
                    `;
                    contenedor.appendChild(div);
                });
                 // Oculta el botÃ³n "Generar Nuevo Examen" y muestra el de "Enviar Respuestas"
                document.getElementById("enviarRespuestas").style.display = "block";
                document.getElementById("nuevoExamen").style.display = "none";
            }

            function evaluarRespuestas() {
                // Esta funciÃ³n evalÃºa las respuestas del usuario
                let correctas = 0;
                preguntasSeleccionadas.forEach((pregunta, index) => {
                    let respuestaUsuario = document.querySelector(`input[name='pregunta${index}']:checked`);
                    let opcionesLabel = document.querySelectorAll(`input[name='pregunta${index}']`);

                    opcionesLabel.forEach(input => {
                        let label = input.parentElement;
                        // Marca la respuesta correcta en verde
                        if (input.value === pregunta.respuestaCorrecta) {
                            label.classList.add('correcta');
                        }
                        // Si el usuario respondiÃ³ y su respuesta no es la correcta, la marca en rojo
                        if (respuestaUsuario && input.value === respuestaUsuario.value && input.value !== pregunta.respuestaCorrecta) {
                            label.classList.add('incorrecta');
                        }
                         // Deshabilita los radio buttons despuÃ©s de evaluar
                        input.disabled = true;
                    });


                    if (respuestaUsuario && respuestaUsuario.value === pregunta.respuestaCorrecta) {
                        correctas++;
                    }
                });
                 // Muestra los resultados y prepara el botÃ³n para el siguiente set de preguntas o reiniciar
                mostrarResultados(correctas);
                document.getElementById("enviarRespuestas").style.display = "none"; // Oculta el botÃ³n de envÃ­o despuÃ©s de evaluar
                 // Si aÃºn quedan preguntas sin responder, muestra el botÃ³n de "Generar Nuevo Examen"
                let preguntasDisponiblesRestantes = Object.values(preguntasPorCapitulo).flat().filter(p => !preguntasRespondidas.has(p.pregunta)).length;
                 if (preguntasDisponiblesRestantes > 0) {
                     document.getElementById("nuevoExamen").innerText = "Siguiente Ronda"; // Cambia el texto del botÃ³n
                     document.getElementById("nuevoExamen").style.display = "block";
                 } else {
                      document.getElementById("preguntas").innerHTML += `<h2>Â¡Banco de preguntas agotado!</h2>`;
                      document.getElementById("nuevoExamen").innerText = "Reiniciar Examen"; // Cambia el texto del botÃ³n
                     document.getElementById("nuevoExamen").style.display = "block";

                 }
            }


            function mostrarResultados(correctas) {
                // Esta funciÃ³n muestra el conteo de respuestas correctas
                let resultadoDiv = document.getElementById("resultados");
                resultadoDiv.innerHTML = `<p>Respuestas correctas en esta ronda: ${correctas}/${preguntasSeleccionadas.length}</p>`;
            }

            // FunciÃ³n para generar un nuevo set de preguntas o finalizar si no hay mÃ¡s
            window.generarNuevoExamen = function () {
                 let preguntasDisponiblesRestantes = Object.values(preguntasPorCapitulo).flat().filter(p => !preguntasRespondidas.has(p.pregunta)).length;
                 if (preguntasDisponiblesRestantes === 0) {
                     // Si ya no hay preguntas disponibles, ofrece reiniciar
                     document.getElementById("preguntas").innerHTML = `<h2>Â¡Enhorabuena! Respondiste todas las preguntas disponibles. Â¿Quieres empezar de nuevo?</h2>`;
                     document.getElementById("enviarRespuestas").style.display = "none";
                     document.getElementById("nuevoExamen").innerText = "Reiniciar Examen";
                     document.getElementById("nuevoExamen").style.display = "block";
                 } else {
                    console.log("Generando nuevo set de preguntas...");
                    seleccionarPreguntas();
                    mostrarPreguntas();
                    document.getElementById("resultados").innerHTML = ""; // Limpia los resultados anteriores
                 }
            };

            // Agrega el evento click al botÃ³n de enviar respuestas
            document.getElementById("enviarRespuestas").addEventListener("click", evaluarRespuestas);

            // FunciÃ³n para reiniciar el examen, reseteando las preguntas respondidas
            window.reiniciarExamen = function () {
                preguntasRespondidas.clear(); // Limpia el set de preguntas respondidas
                document.getElementById("resultados").innerHTML = ""; // Limpia los resultados
                 // Recarga todas las preguntas disponibles y empieza un nuevo examen
                let todasLasPreguntas = Object.values(preguntasPorCapitulo).flat();
                if (todasLasPreguntas.length > 0) {
                    totalPreguntas = todasLasPreguntas.length; // Asegura que totalPreguntas refleje el banco completo
                     document.getElementById("preguntas").innerHTML = ""; // Limpia el contenedor de preguntas anterior
                    generarNuevoExamen(); // Genera el primer set del examen reiniciado
                } else {
                    document.getElementById("preguntas").innerHTML = `<h2>No se pudieron cargar las preguntas. Por favor, revisa el archivo Hoja 1.html.</h2>`;
                     document.getElementById("enviarRespuestas").style.display = "none";
                     document.getElementById("nuevoExamen").style.display = "none";
                }

            };

            // Carga las preguntas al iniciar la pÃ¡gina
            cargarPreguntas();
        });
    </script>
</body>
</html>
